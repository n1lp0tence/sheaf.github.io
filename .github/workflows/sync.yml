name: Sync PDFs from private releases

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout destination repo
        uses: actions/checkout@v4

      - name: Ensure /files directory exists
        run: mkdir -p files

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download & update PDFs
        env:
          TOKEN: ${{ secrets.SOURCE_REPO_TOKEN }}
        run: |
          set -euo pipefail

          OWNER="n1lp0tence"
          TAG="pdf-latest"
          ASSET="main.pdf"
          LIST="_data/files.json"

          [[ -f "$LIST" ]] || { echo "Missing $LIST"; exit 1; }

          # Optional but very helpful: fail early if JSON is invalid
          jq -e '.' "$LIST" >/dev/null

          changed=0

          # Iterate JSON entries WITHOUT a pipe-subshell
          while IFS= read -r entry; do
            repo_slug="$(jq -r '.repo' <<<"$entry")"
            type="$(jq -r '.type' <<<"$entry")"

            [[ -z "$repo_slug" || "$repo_slug" == "null" ]] && continue

            full_repo="$OWNER/$repo_slug"
            dest="files/${repo_slug}.pdf"

            echo "== Syncing $full_repo@$TAG ($ASSET -> $dest) [$type] =="

            tmpdir="$(mktemp -d)"
            rel_json="$tmpdir/release.json"
            newfile="$tmpdir/new.pdf"

            curl -fsSL \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$full_repo/releases/tags/$TAG" \
              > "$rel_json"

            asset_id="$(jq -r --arg name "$ASSET" '.assets[] | select(.name==$name) | .id' "$rel_json" | head -n1)"
            if [[ -z "${asset_id:-}" || "$asset_id" == "null" ]]; then
              echo "ERROR: asset '$ASSET' not found in release $full_repo@$TAG"
              echo "Available assets:"
              jq -r '.assets[].name' "$rel_json" || true
              exit 1
            fi

            curl -fsSL \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/octet-stream" \
              "https://api.github.com/repos/$full_repo/releases/assets/$asset_id" \
              -o "$newfile"

            if [[ -f "$dest" ]]; then
              oldhash="$(sha256sum "$dest" | awk '{print $1}')"
              newhash="$(sha256sum "$newfile" | awk '{print $1}')"
              if [[ "$oldhash" == "$newhash" ]]; then
                echo "No change (sha256 match)."
                rm -rf "$tmpdir"
                continue
              fi
              echo "Changed: $oldhash -> $newhash"
            else
              echo "New file."
            fi

            mv "$newfile" "$dest"
            rm -rf "$tmpdir"
            changed=1
          done < <(jq -c '.[]' "$LIST")

          echo "CHANGED=$changed" >> "$GITHUB_ENV"

      - name: Commit changes if updated
        if: env.CHANGED == '1'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add files/
          git commit -m "chore: sync PDFs from private releases"
          git push

      - name: No changes
        if: env.CHANGED != '1'
        run: echo "No PDF updates detected; nothing to commit."
